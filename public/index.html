<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat & Next Prayer</title>
    <style>
        :root { --primary: #2e7d32; --accent: #ff9800; --bg: #f0f2f0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }

        .header { text-align: center; margin-bottom: 20px; }
        .city-name { margin: 0; color: var(--primary); font-size: 1.5rem; }
        .timezone { font-size: 0.8rem; color: #888; font-weight: bold; }

        .next-prayer-card { background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .next-label { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; }
        .next-time { font-size: 2rem; font-weight: 800; margin: 5px 0; }

        .search-box { position: relative; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; outline: none; box-sizing: border-box; }
        #suggestions { position: absolute; background: white; width: 100%; border: 1px solid #ddd; z-index: 100; display: none; max-height: 150px; overflow-y: auto; border-radius: 8px; }
        .item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }

        .time-row { display: flex; justify-content: space-between; padding: 12px 15px; margin-bottom: 8px; border-radius: 10px; background: #f9f9f9; border: 1px solid transparent; }
        .active-row { border-color: var(--accent); background: #fffde7; }
        .label { font-weight: 600; color: #555; }
        .time { font-weight: 800; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2 id="cityName" class="city-name">---</h2>
        <span id="tzLabel" class="timezone">WIB</span>
    </div>

    <div id="nextPrayerBox" class="next-prayer-card" style="display:none;">
        <div class="next-label">Selanjutnya: <span id="nextName">--</span></div>
        <div id="nextTime" class="next-time">--:--</div>
    </div>

    <div class="search-box">
        <input type="text" id="cityInput" placeholder="Cari Kota..." autocomplete="off">
        <div id="suggestions"></div>
    </div>

    <div id="schedule"></div>
</div>

<script>
    // Added TZ property: 1 = WIB, 2 = WITA, 3 = WIT
    const CITIES = [
        { id: "1301", name: "DKI JAKARTA", tz: "WIB" },
        { id: "1210", name: "KOTA BANDUNG", tz: "WIB" },
        { id: "1524", name: "KOTA SURABAYA", tz: "WIB" },
        { id: "3171", name: "KOTA MAKASSAR", tz: "WITA" },
        { id: "1801", name: "KOTA DENPASAR", tz: "WITA" },
        { id: "3318", name: "KOTA JAYAPURA", tz: "WIT" }
    ];

    let currentSchedule = {};

    async function update(id, name, tz) {
        document.getElementById('suggestions').style.display = 'none';
        try {
            const res = await fetch(`/.netlify/functions/index?city=${id}`);
            const data = await res.json();

            currentSchedule = data.jadwal;
            document.getElementById('cityName').innerText = name;
            document.getElementById('tzLabel').innerText = tz;

            renderSchedule();
            findNextPrayer();
        } catch (e) { console.error("Update failed"); }
    }

    function renderSchedule() {
        const list = ['subuh', 'dzuhur', 'ashar', 'maghrib', 'isya'];
        document.getElementById('schedule').innerHTML = list.map(p => `
            <div class="time-row" id="row-${p}">
                <span class="label">${p.toUpperCase()}</span>
                <span class="time">${currentSchedule[p]}</span>
            </div>
        `).join('');
    }

    function findNextPrayer() {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const list = ['subuh', 'dzuhur', 'ashar', 'maghrib', 'isya'];

        let next = null;

        for (let p of list) {
            const [h, m] = currentSchedule[p].split(':');
            const pTime = parseInt(h) * 60 + parseInt(m);

            if (pTime > currentTime) {
                next = { name: p, time: currentSchedule[p] };
                break;
            }
        }

        // If all prayers today passed, next is Subuh tomorrow
        if (!next) next = { name: 'subuh', time: currentSchedule['subuh'] };

        document.getElementById('nextName').innerText = next.name.toUpperCase();
        document.getElementById('nextTime').innerText = next.time;
        document.getElementById('nextPrayerBox').style.display = 'block';

        // Highlight in the list
        document.querySelectorAll('.time-row').forEach(el => el.classList.remove('active-row'));
        document.getElementById(`row-${next.name}`).classList.add('active-row');
    }

    // Search logic
    document.getElementById('cityInput').addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase();
        const suggest = document.getElementById('suggestions');
        if (val.length < 2) { suggest.style.display = 'none'; return; }
        const matches = CITIES.filter(c => c.name.includes(val));
        suggest.innerHTML = matches.map(c => `<div class="item" onclick="update('${c.id}','${c.name}','${c.tz}')">${c.name}</div>`).join('');
        suggest.style.display = matches.length ? 'block' : 'none';
    });

    window.onload = () => update("1301", "DKI JAKARTA", "WIB");
</script>
</body>
</html>
