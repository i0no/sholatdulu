<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat Indonesia</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --error: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px 20px; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }

        .search-container { display: flex; gap: 10px; margin-bottom: 25px; }
        input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 10px; outline: none; transition: border-color 0.3s; }
        input:focus { border-color: var(--accent); }
        button { padding: 12px 20px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }

        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f9f9f9; padding-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        .header p { margin: 5px 0 0; color: #7f8c8d; font-size: 0.9rem; }

        .time-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f1f1; }
        .time-row:last-child { border-bottom: none; }
        .label { font-weight: 600; color: #555; text-transform: uppercase; font-size: 0.85rem; }
        .time { font-weight: 800; color: var(--primary); font-size: 1.1rem; }

        .status-msg { text-align: center; padding: 10px; border-radius: 8px; font-size: 0.9rem; display: none; margin-bottom: 15px; }
        .error { display: block; background: #fdeaea; color: var(--error); border: 1px solid #fadbd8; }
        .loading { display: block; background: #eafaf1; color: var(--accent); }
    </style>
</head>
<body>

<div class="card">
    <div class="search-container">
        <input type="text" id="cityInput" placeholder="Masukkan nama kota..." value="Jakarta">
        <button onclick="searchAndFetch()">CARI</button>
    </div>

    <div id="status" class="status-msg"></div>

    <div id="mainContent" style="display:none;">
        <div class="header">
            <h1 id="cityName">---</h1>
            <p id="dateDisplay">---</p>
        </div>
        <div id="prayerTimes">
            </div>
    </div>
</div>

<script>
    const statusEl = document.getElementById('status');
    const contentEl = document.getElementById('mainContent');

    function showStatus(msg, type) {
        statusEl.innerText = msg;
        statusEl.className = `status-msg ${type}`;
        statusEl.style.display = 'block';
    }

    async function searchAndFetch() {
        const query = document.getElementById('cityInput').value.trim();
        if (!query) return;

        showStatus("Mencari kota...", "loading");
        contentEl.style.display = 'none';

        try {
            // 1. Find City ID from the public API
            const searchUrl = `https://api.myquran.com/v2/sholat/kota/cari/${encodeURIComponent(query)}`;
            const searchRes = await fetch(searchUrl);
            const searchData = await searchRes.json();

            if (!searchData.status || !searchData.data || searchData.data.length === 0) {
                showStatus("Kota tidak ditemukan. Coba nama lain.", "error");
                return;
            }

            const cityId = searchData.data[0].id;

            // 2. Fetch Schedule using YOUR Netlify Function (index.js)
            // We try the redirect path first, then fallback to direct path
            let data;
            try {
                const res = await fetch(`/api/jadwal?city=${cityId}`);
                if (!res.ok) throw new Error();
                data = await res.json();
            } catch (err) {
                // FALLBACK: Directly calling the function name index.js
                const fallback = await fetch(`/.netlify/functions/index?city=${cityId}`);
                if (!fallback.ok) throw new Error("Gagal memuat jadwal dari server.");
                data = await fallback.json();
            }

            // 3. Populate UI
            document.getElementById('cityName').innerText = data.lokasi;
            document.getElementById('dateDisplay').innerText = data.jadwal.tanggal;

            const prayerList = ['imsak', 'subuh', 'terbit', 'dhuha', 'dzuhur', 'ashar', 'maghrib', 'isya'];
            const container = document.getElementById('prayerTimes');

            container.innerHTML = prayerList.map(p => `
                <div class="time-row">
                    <span class="label">${p}</span>
                    <span class="time">${data.jadwal[p]}</span>
                </div>
            `).join('');

            statusEl.style.display = 'none';
            contentEl.style.display = 'block';

        } catch (e) {
            console.error(e);
            showStatus(`Error: ${e.message || "Gagal mengambil data"}`, "error");
        }
    }

    // Auto-load Jakarta on start
    window.onload = searchAndFetch;
</script>

</body>
</html>
